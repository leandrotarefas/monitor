import java.io.*;
import java.net.*;

public class SocketServer {
    public static void main(String[] args) {
        int port = 50817;

        try (ServerSocket serverSocket = new ServerSocket(port)) {
            System.out.println("Servidor escutando na porta " + port);

            while (true) {
                Socket socket = serverSocket.accept();

                // Criar uma nova thread para lidar com cada conexão de cliente
                Thread thread = new Thread(() -> {
                    try {
                        // Obter o fluxo de entrada do cliente
                        InputStream inputStream = socket.getInputStream();

                        // Criar um arquivo com timestamp
                        String filename = getTimestampFilename();
                        FileOutputStream fileOutputStream = new FileOutputStream(filename);

                        // Ler e salvar o buffer recebido no arquivo
                        byte[] buffer = new byte[1024];
                        int bytesRead;

                        while ((bytesRead = inputStream.read(buffer)) != -1) {
                            fileOutputStream.write(buffer, 0, bytesRead);
                        }

                        fileOutputStream.close();
                        System.out.println("Arquivo salvo: " + filename);

                        // Redirecionar o buffer para outro servidor de socket em localhost
                        redirectToSocket(filename, "localhost", 40817);

                        socket.close();
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                });

                // Iniciar a nova thread para lidar com a conexão do cliente
                thread.start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static String getTimestampFilename() {
        long currentTime = System.currentTimeMillis();
        String filename = String.format("%tF.%tT.%tL.txt", currentTime, currentTime, currentTime);
        return filename;
    }

    private static void redirectToSocket(String filename, String host, int port) throws IOException {
        try (Socket socket = new Socket(host, port)) {
            FileInputStream fileInputStream = new FileInputStream(filename);
            OutputStream outputStream = socket.getOutputStream();

            byte[] buffer = new byte[1024];
            int bytesRead;

            while ((bytesRead = fileInputStream.read(buffer)) != -1) {
                outputStream.write(buffer, 0, bytesRead);
            }

            fileInputStream.close();
            outputStream.close();
        }
    }
}
