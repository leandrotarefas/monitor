const mongoose = require('mongoose');
const fs = require('fs');
const fastcsv = require('fast-csv');

// Defina suas configurações de conexão ao MongoDB
const uri = "mongodb+srv://<user>:<password>@cluster.mongodb.net/<NomeDoBancoDeDados>";

const schema = new mongoose.Schema({}, { strict: false }); // Schema não estrito para ler qualquer coleção
const Model = mongoose.model('<NomeDaColecao>', schema);

async function fetchFromDB(mappings) {
  await mongoose.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });

  let results = [];
  const docs = await Model.find({});

  for (let doc of docs) {
    let row = {};
    for (let [col, path] of Object.entries(mappings)) {
      const value = path.split('.').reduce((obj, p) => (obj && obj[p]) ? obj[p] : null, doc._doc);
      row[col] = value;
    }
    results.push(row);
  }

  await mongoose.disconnect();

  return results;
}

const mappings = {
  "nome": "data.nome",
  "phone": "data.customer.phone"
};

fetchFromDB(mappings).then(results => {
  const ws = fs.createWriteStream('output.csv');
  fastcsv.write(results, { headers: true }).pipe(ws);
}).catch(err => {
  console.error('Erro ao buscar dados:', err);
});
